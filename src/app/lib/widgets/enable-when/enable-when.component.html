@if (booleanControlled) {
  <lfb-boolean-controlled
    [(bool)]="booleanControlledOption"
    [controlWidthClass]="controlWidthClass"
    [labelWidthClass]="labelWidthClass"
    [label]="booleanLabel"
    [labelPosition]="labelPosition"
    [helpMessage]="schema.description"
  ></lfb-boolean-controlled>
}

@if (!booleanControlled || booleanControlledOption) {
  <div class="widget form-group m-0"
       [ngClass]="{'row': labelPosition === 'left'}">
    <div [ngClass]="labelWidthClass + ' ps-0 pe-1'">
      @if (!noCollapseButton) {
        <button href="#" type="button"
                [ngClass]="{'float-sm-right': labelPosition === 'left'}"
                class="btn btn-default collapse-button" (click)="isCollapsed = !isCollapsed"
                [attr.aria-expanded]="!isCollapsed" [attr.aria-controls]="tableId">
          <fa-icon [icon]="isCollapsed ? faRight : faDown" aria-hidden="true"></fa-icon>
        </button>
      }
      @if (!noTableLabel) {
        <lfb-label [title]="schema.title" [helpMessage]="schema.description" [for]="id"></lfb-label>
      }
    </div>

    <div class="p-0 card {{controlWidthClass}}" [attr.id]="tableId">
      @if (noTableLabel) {
        <lfb-label [helpMessage]="schema.description" [title]="schema.title"
                   [labelId]="'label_'+id" [for]="id"></lfb-label>
      }
      @if (+formProperty.properties.length > 0) {
        <table class="table table-borderless table-sm lfb-table">
          @if (!noHeader) {
            <thead class="table-active">
              <tr>
                @for (showField of showHeaderFields; track showField.field) {
                  <th class="col-sm{{showField.col ? ('-'+showField.col) : ''}}" scope="col">
                    <lfb-title
                      [title]="showField.title"
                      [helpMessage]="getProperty(formProperty.properties[0], 'answerString').schema.description"
                    ></lfb-title>
                  </th>
                }
                @if (!singleItem) {
                  <th class="col-sm-1"></th>
                }
              </tr>
            </thead>
          }

          <tbody [ngbCollapse]="isCollapsed">
            @for (rowProperty of rowProperties; track rowProperty.canonicalPathNotation; let rowNum = $index) {
              <tr class="p-0 m-0">
                @for (showField of getFields(rowProperty); track showField.field; let colNum = $index) {
                  <td class="col-sm{{showField.col ? ('-'+showField.col) : ''}} p-0 pb-1 pe-1 m-0 align-self-center"
                      [ngClass]="{invalid: !isValid(rowProperty, showField.field)}"
                      lfbEWValidate [formProperty]="getProperty(rowProperty, showField.field)"
                      (isError)="onError(rowNum, colNum, getProperty(rowProperty, showField.field))"
                    >
                    @if (isShow(rowProperty, showField.field)) {
                      <lfb-form-element [nolabel]="true"
                                        [formProperty]="getProperty(rowProperty, showField.field)"
                      ></lfb-form-element>
                    }
                  </td>
                }
                <td class="col-sm-1 align-inherit p-0 m-0 align-self-center">
                  <button [attr.id]="rowProperty.canonicalPathNotation+'_remove'"  (click)="removeProperty(rowNum)" class="btn btn-default btn-link btn-sm array-remove-button"
                          [attr.disabled]="isRemoveButtonDisabled() ? '' : null"
                          matTooltip="Remove" aria-label="Remove"
                  >
                    <fa-icon [icon]="faRemove" aria-hidden="true"></fa-icon>
                  </button>
                  @if (getEnableWhenFieldErrors(rowNum, rowProperty, getFields(rowProperty)) | async; as rowErrorMessage) {
                    <div tabindex="0" [attr.id]="rowProperty.canonicalPathNotation+'_err'"
                         class="btn border-0 p-0 b-0 enable-when-errors"
                         [matTooltip]="rowErrorMessage"
                    >
                      <fa-icon [icon]="warningIcon" style="color: red" aria-hidden="true"></fa-icon>
                      @if (!awaitingValidation) {
                        <small class="text-danger form-text sr-only" role="alert">
                          {{composeAccessibleErrorMessage(rowErrorMessage, rowNum)}}
                        </small>
                      }
                    </div>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      }

      @if (!singleItem &&
           (!(schema.hasOwnProperty('minItems') && schema.hasOwnProperty('maxItems') && schema.minItems === schema.maxItems))) {
        <button (click)="addItemWithAlert(alertPopover)" class="btn btn-sm btn-light text-primary shadow-sm array-add-button"
                [attr.disabled]="isAddButtonDisabled() ? '' : null"
                [ngbPopover]="'Please fill in the above fields before adding a new item'"
                #alertPopover="ngbPopover" triggers="manual" placement="bottom top"
                popoverClass=""
        >
          <fa-icon [icon]="faAdd" aria-hidden="true"></fa-icon> {{addButtonLabel}}
        </button>
      }
    </div>
  </div>
}
